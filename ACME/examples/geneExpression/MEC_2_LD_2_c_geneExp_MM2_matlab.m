% function [tout,X,Y] = MEC_2_LD_2_c_geneExp_MM2_matlab(t,theta,kappa) 
function varargout = MEC_2_LD_2_c_geneExp_MM2_matlab(varargin) 

t = varargin{1};
theta = varargin{2};
if(nargin>=3)
    kappa=varargin{3};
   if(length(kappa)==1)
    kappa(2:29)=0;
   end
else
    kappa = zeros(1,29);
end
% Initial conditions
x0 = x0fun(theta,kappa);

% Simulation
[tout,X] = ode15s(@(t,x) rhs(t,x,theta,kappa),t,x0);
Y = rhsO(t,X,theta,kappa);

% Assign output
varargout{1} = tout;
if nargout >= 2
varargout{2} = X;
end
if nargout >= 3
    varargout{3} = Y;
end
if nargout >= 4
    error('Too many output arguments.');
end


%% RIGHT-HAND SIDE
function [dxdt] = rhs(t,x,theta,kappa) 

dxdt = [-(kappa(1)^2*theta(7)*x(8) + kappa(1)*theta(1)*x(1) - kappa(1)*theta(2)*x(2) + kappa(1)^2*theta(7)*x(1)*x(4))/kappa(1);...
         (kappa(1)^2*theta(7)*x(8) + kappa(1)*theta(1)*x(1) - kappa(1)*theta(2)*x(2) + kappa(1)^2*theta(7)*x(1)*x(4))/kappa(1);...
         (kappa(1)*theta(3)*x(2) - kappa(1)*theta(4)*x(3))/kappa(1);...
         (kappa(1)*theta(5)*x(3) - kappa(1)*theta(6)*x(4))/kappa(1);...
         (2*kappa(1)^2*theta(2)*x(6) - 2*kappa(1)^2*theta(1)*x(5) + kappa(1)^2*theta(7)*x(8) + kappa(1)*theta(1)*x(1) + kappa(1)*theta(2)*x(2) + kappa(1)^2*theta(7)*x(1)*x(4) - 2*kappa(1)^3*theta(7)*x(1)*x(8) - 2*kappa(1)^3*theta(7)*x(4)*x(5))/kappa(1)^2;...
         -(kappa(1)^2*theta(1)*x(6) - kappa(1)^2*theta(1)*x(5) + kappa(1)^2*theta(2)*x(6) - kappa(1)^2*theta(2)*x(9) + kappa(1)^2*theta(7)*x(8) + kappa(1)*theta(1)*x(1) + kappa(1)*theta(2)*x(2) + kappa(1)^2*theta(7)*x(1)*x(4) - kappa(1)^3*theta(7)*x(1)*x(8) - kappa(1)^3*theta(7)*x(4)*x(5) + kappa(1)^3*theta(7)*x(4)*x(6) + kappa(1)^3*theta(7)*x(1)*x(11))/kappa(1)^2;...
         -(kappa(1)^2*theta(1)*x(7) - kappa(1)^2*theta(3)*x(6) + kappa(1)^2*theta(4)*x(7) - kappa(1)^2*theta(2)*x(10) + kappa(1)^3*theta(7)*x(4)*x(7) + kappa(1)^3*theta(7)*x(1)*x(13))/kappa(1)^2;...
         -(kappa(1)^2*theta(1)*x(8) - kappa(1)^2*theta(5)*x(7) - kappa(1)^2*theta(2)*x(11) + kappa(1)^2*theta(6)*x(8) + kappa(1)^3*theta(7)*x(4)*x(8) + kappa(1)^3*theta(7)*x(1)*x(14))/kappa(1)^2;...
         (2*kappa(1)^2*theta(1)*x(6) - 2*kappa(1)^2*theta(2)*x(9) + kappa(1)^2*theta(7)*x(8) + kappa(1)*theta(1)*x(1) + kappa(1)*theta(2)*x(2) + kappa(1)^2*theta(7)*x(1)*x(4) + 2*kappa(1)^3*theta(7)*x(4)*x(6) + 2*kappa(1)^3*theta(7)*x(1)*x(11))/kappa(1)^2;...
         (kappa(1)^2*theta(1)*x(7) - kappa(1)^2*theta(2)*x(10) + kappa(1)^2*theta(3)*x(9) - kappa(1)^2*theta(4)*x(10) + kappa(1)^3*theta(7)*x(4)*x(7) + kappa(1)^3*theta(7)*x(1)*x(13))/kappa(1)^2;...
         (kappa(1)^2*theta(1)*x(8) - kappa(1)^2*theta(2)*x(11) + kappa(1)^2*theta(5)*x(10) - kappa(1)^2*theta(6)*x(11) + kappa(1)^3*theta(7)*x(4)*x(8) + kappa(1)^3*theta(7)*x(1)*x(14))/kappa(1)^2;...
         (2*kappa(1)^2*theta(3)*x(10) - 2*kappa(1)^2*theta(4)*x(12) + kappa(1)*theta(3)*x(2) + kappa(1)*theta(4)*x(3))/kappa(1)^2;...
         (kappa(1)^2*theta(3)*x(11) - kappa(1)^2*theta(4)*x(13) + kappa(1)^2*theta(5)*x(12) - kappa(1)^2*theta(6)*x(13))/kappa(1)^2;...
         (2*kappa(1)^2*theta(5)*x(13) - 2*kappa(1)^2*theta(6)*x(14) + kappa(1)*theta(5)*x(3) + kappa(1)*theta(6)*x(4))/kappa(1)^2];

%% OUTPUT MAP
function y = rhsO(t,x,theta,kappa) 

y = [theta(9) + theta(8).*x(:,4),...
         theta(8).^2.*x(:,14)];


%% INITIAL CONDITIONS FOR STATE
function x0 = x0fun(theta,kappa) 

x0 = [(kappa(2)*kappa(16) - kappa(2) + 1)/kappa(1);...
       (kappa(3)*kappa(17))/kappa(1);...
       (kappa(4)*kappa(18) - theta(10)*(kappa(4) - 1))/kappa(1);...
       (kappa(5)*kappa(19))/kappa(1);...
       (kappa(6)*kappa(20))/kappa(1)^2;...
       (kappa(7)*kappa(21))/kappa(1)^2;...
       (kappa(8)*kappa(22))/kappa(1)^2;...
       (kappa(9)*kappa(23))/kappa(1)^2;...
       (kappa(10)*kappa(24))/kappa(1)^2;...
       (kappa(11)*kappa(25))/kappa(1)^2;...
       (kappa(12)*kappa(26))/kappa(1)^2;...
       (kappa(13)*kappa(27))/kappa(1)^2;...
       (kappa(14)*kappa(28))/kappa(1)^2;...
       (kappa(15)*kappa(29))/kappa(1)^2];


