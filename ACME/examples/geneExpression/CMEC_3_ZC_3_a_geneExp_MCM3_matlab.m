% function [tout,X,MX,Y] = CMEC_3_ZC_3_a_geneExp_MCM3_matlab(t,theta,kappa) 
function varargout = CMEC_3_ZC_3_a_geneExp_MCM3_matlab(varargin) 

t = varargin{1};
theta = varargin{2};
if(nargin>=3)
    kappa=varargin{3};
   if(length(kappa)==1)
    kappa(2:29)=0;
   end
else
    kappa = zeros(1,29);
end
x0 = [];
% Initial conditions
    x0 = x0fun(theta,kappa);

% Simulation
options = odeset('Mass',@(t,x) MMat(t,x,theta,kappa),...
'MStateDependence','strong','RelTol',1e-8,'AbsTol',1e-8);
[tout,X] = ode15s(@(t,x) rhs(t,x,theta,kappa),t,x0,options);
Y = rhsO(t,X,theta,kappa);

% Assign output
varargout{1} = tout;
if nargout >= 2
varargout{2} = X;
end
if nargout >= 3
    % Overall moments of species
    varargout{3} = Y(:,1:34);
end
if nargout >= 4
    % Moments of output variables
    varargout{4} = Y(:,35:end);
end
if nargout >= 5
    error('Too many output arguments.');
end


%% RIGHT-HAND SIDE
function [dxdt] = rhs(t,x,theta,kappa) 

dxdt = [theta(2)*x(2) - theta(1)*x(1) - theta(7)*x(1)*x(4);...
         theta(1)*x(1) - theta(2)*x(2) + theta(7)*x(1)*x(4);...
         - x(2)*(theta(2)*x(3) - theta(2)*x(12)) - theta(4)*x(1)*x(3) - theta(7)*x(1)*x(6);...
         theta(5)*x(1)*x(3) - x(2)*(theta(2)*x(4) - theta(2)*x(13)) - theta(6)*x(1)*x(4) - theta(7)*x(1)*x(7);...
         x(2)*(theta(2)*x(14) - theta(2)*x(5) + theta(2)*x(3)^2 + theta(2)*x(12)^2 - 2*theta(2)*x(3)*x(12)) + theta(4)*x(1)*x(3) - 2*theta(4)*x(1)*x(5) - theta(7)*x(1)*x(9);...
         theta(5)*x(1)*x(5) - theta(4)*x(1)*x(6) - x(2)*(theta(2)*x(6) - theta(2)*x(15) - theta(2)*x(3)*x(4) + theta(2)*x(3)*x(13) + theta(2)*x(4)*x(12) - theta(2)*x(12)*x(13)) - theta(6)*x(1)*x(6) - theta(7)*x(1)*x(10);...
         x(2)*(theta(2)*x(16) - theta(2)*x(7) + theta(2)*x(4)^2 + theta(2)*x(13)^2 - 2*theta(2)*x(4)*x(13)) + theta(5)*x(1)*x(3) + theta(6)*x(1)*x(4) + 2*theta(5)*x(1)*x(6) - 2*theta(6)*x(1)*x(7) - theta(7)*x(1)*x(11);...
         3*theta(4)*x(1)*x(5) - theta(4)*x(1)*x(3) - x(2)*(theta(2)*x(8) - theta(2)*x(17) + theta(2)*x(3)^3 - theta(2)*x(12)^3 + 3*theta(2)*x(3)*x(12)^2 - 3*theta(2)*x(3)^2*x(12) + 3*theta(2)*x(3)*x(14) - 3*theta(2)*x(12)*x(14) - 3*theta(2)*x(1)*x(3)*x(5) + 3*theta(2)*x(1)*x(5)*x(12)) - 3*theta(4)*x(1)*x(8) - 3*theta(4)*x(1)*x(3)*x(5) - 3*theta(7)*x(1)*x(5)*x(6) + 3*theta(4)*x(1)^2*x(3)*x(5) + 3*theta(7)*x(1)^2*x(5)*x(6);...
         2*theta(7)*x(1)^2*x(6)^2 - 2*theta(7)*x(1)*x(6)^2 - x(2)*(theta(2)*x(9) - theta(2)*x(18) + theta(2)*x(3)^2*x(4) + theta(2)*x(4)*x(12)^2 - theta(2)*x(3)^2*x(13) - theta(2)*x(12)^2*x(13) + 2*theta(2)*x(3)*x(15) + theta(2)*x(4)*x(14) - 2*theta(2)*x(12)*x(15) - theta(2)*x(13)*x(14) - 2*theta(2)*x(1)*x(3)*x(6) - theta(2)*x(1)*x(4)*x(5) + theta(2)*x(1)*x(5)*x(13) + 2*theta(2)*x(1)*x(6)*x(12) - 2*theta(2)*x(3)*x(4)*x(12) + 2*theta(2)*x(3)*x(12)*x(13)) + theta(4)*x(1)*x(6) - 2*theta(4)*x(1)*x(9) + theta(5)*x(1)*x(8) - theta(6)*x(1)*x(9) - 2*theta(4)*x(1)*x(3)*x(6) + theta(5)*x(1)*x(3)*x(5) - theta(6)*x(1)*x(4)*x(5) - theta(7)*x(1)*x(5)*x(7) + 2*theta(4)*x(1)^2*x(3)*x(6) - theta(5)*x(1)^2*x(3)*x(5) + theta(6)*x(1)^2*x(4)*x(5) + theta(7)*x(1)^2*x(5)*x(7);...
         theta(5)*x(1)*x(5) - x(2)*(theta(2)*x(10) - theta(2)*x(19) + theta(2)*x(3)*x(4)^2 + theta(2)*x(3)*x(13)^2 - theta(2)*x(4)^2*x(12) - theta(2)*x(12)*x(13)^2 + theta(2)*x(3)*x(16) + 2*theta(2)*x(4)*x(15) - theta(2)*x(12)*x(16) - 2*theta(2)*x(13)*x(15) - theta(2)*x(1)*x(3)*x(7) - 2*theta(2)*x(1)*x(4)*x(6) + 2*theta(2)*x(1)*x(6)*x(13) + theta(2)*x(1)*x(7)*x(12) - 2*theta(2)*x(3)*x(4)*x(13) + 2*theta(2)*x(4)*x(12)*x(13)) + theta(6)*x(1)*x(6) - theta(4)*x(1)*x(10) + 2*theta(5)*x(1)*x(9) - 2*theta(6)*x(1)*x(10) - theta(4)*x(1)*x(3)*x(7) + 2*theta(5)*x(1)*x(3)*x(6) - 2*theta(6)*x(1)*x(4)*x(6) - 3*theta(7)*x(1)*x(6)*x(7) + theta(4)*x(1)^2*x(3)*x(7) - 2*theta(5)*x(1)^2*x(3)*x(6) + 2*theta(6)*x(1)^2*x(4)*x(6) + 3*theta(7)*x(1)^2*x(6)*x(7);...
         3*theta(7)*x(1)^2*x(7)^2 - 3*theta(7)*x(1)*x(7)^2 - x(2)*(theta(2)*x(11) - theta(2)*x(20) + theta(2)*x(4)^3 - theta(2)*x(13)^3 + 3*theta(2)*x(4)*x(13)^2 - 3*theta(2)*x(4)^2*x(13) + 3*theta(2)*x(4)*x(16) - 3*theta(2)*x(13)*x(16) - 3*theta(2)*x(1)*x(4)*x(7) + 3*theta(2)*x(1)*x(7)*x(13)) + theta(5)*x(1)*x(3) - theta(6)*x(1)*x(4) + 3*theta(5)*x(1)*x(6) + 3*theta(6)*x(1)*x(7) + 3*theta(5)*x(1)*x(10) - 3*theta(6)*x(1)*x(11) + 3*theta(5)*x(1)*x(3)*x(7) - 3*theta(6)*x(1)*x(4)*x(7) - 3*theta(5)*x(1)^2*x(3)*x(7) + 3*theta(6)*x(1)^2*x(4)*x(7);...
         x(2)*(theta(3) - theta(4)*x(12)) + theta(1)*x(1)*x(3) - theta(1)*x(1)*x(12) + theta(7)*x(1)*x(6) + theta(7)*x(1)*x(3)*x(4) - theta(7)*x(1)*x(4)*x(12);...
         x(2)*(theta(5)*x(12) - theta(6)*x(13)) + theta(7)*x(1)*x(4)^2 + theta(1)*x(1)*x(4) - theta(1)*x(1)*x(13) + theta(7)*x(1)*x(7) - theta(7)*x(1)*x(4)*x(13);...
         x(2)*(theta(3) + theta(4)*x(12) - 2*theta(4)*x(14)) - x(14)*(theta(1)*x(1) + theta(7)*x(1)*x(4)) + theta(1)*x(1)*(x(3) - x(12))^2 + theta(7)*x(1)*(x(9) + x(4)*x(5)) + theta(1)*x(1)*x(5) + theta(7)*x(1)*x(6)*(2*x(3) - 2*x(12)) + theta(7)*x(1)*x(4)*(x(3) - x(12))^2;...
         theta(7)*x(1)*(x(10) + x(4)*x(6)) - x(15)*(theta(1)*x(1) + theta(7)*x(1)*x(4)) - x(2)*(theta(4)*x(15) - theta(5)*x(14) + theta(6)*x(15)) + theta(1)*x(1)*x(6) + theta(7)*x(1)*x(7)*(x(3) - x(12)) + theta(7)*x(1)*x(6)*(x(4) - x(13)) + theta(1)*x(1)*(x(3) - x(12))*(x(4) - x(13)) + theta(7)*x(1)*x(4)*(x(3) - x(12))*(x(4) - x(13));...
         x(2)*(theta(5)*x(12) + theta(6)*x(13) + 2*theta(5)*x(15) - 2*theta(6)*x(16)) - x(16)*(theta(1)*x(1) + theta(7)*x(1)*x(4)) + theta(1)*x(1)*(x(4) - x(13))^2 + theta(7)*x(1)*(x(11) + x(4)*x(7)) + theta(1)*x(1)*x(7) + theta(7)*x(1)*x(7)*(2*x(4) - 2*x(13)) + theta(7)*x(1)*x(4)*(x(4) - x(13))^2;...
         theta(1)*x(1)*x(3)^3 - x(2)^2*(3*theta(3)*x(14) - 3*theta(4)*x(12)*x(14)) - x(2)*(theta(4)*x(12) - theta(3) - 3*theta(3)*x(14) - 3*theta(4)*x(14) + 3*theta(4)*x(17) + 3*theta(4)*x(12)*x(14) + 3*theta(1)*x(1)*x(3)*x(14) - 3*theta(1)*x(1)*x(12)*x(14) + 3*theta(7)*x(1)*x(6)*x(14) + 3*theta(7)*x(1)*x(3)*x(4)*x(14) - 3*theta(7)*x(1)*x(4)*x(12)*x(14)) - theta(1)*x(1)*x(12)^3 + theta(1)*x(1)*x(8) - theta(1)*x(1)*x(17) + 3*theta(1)*x(1)*x(3)*x(5) - 3*theta(1)*x(1)*x(5)*x(12) + 3*theta(7)*x(1)*x(5)*x(6) + 3*theta(7)*x(1)*x(3)*x(9) + theta(7)*x(1)*x(4)*x(8) - theta(7)*x(1)*x(4)*x(17) - 3*theta(7)*x(1)*x(9)*x(12) + theta(7)*x(1)*x(3)^3*x(4) + 3*theta(1)*x(1)*x(3)*x(12)^2 - 3*theta(1)*x(1)*x(3)^2*x(12) + 3*theta(7)*x(1)*x(3)^2*x(6) - theta(7)*x(1)*x(4)*x(12)^3 + 3*theta(7)*x(1)*x(6)*x(12)^2 + 3*theta(7)*x(1)*x(3)*x(4)*x(12)^2 - 3*theta(7)*x(1)*x(3)^2*x(4)*x(12) + 3*theta(7)*x(1)*x(3)*x(4)*x(5) - 6*theta(7)*x(1)*x(3)*x(6)*x(12) - 3*theta(7)*x(1)*x(4)*x(5)*x(12);...
         2*theta(7)*x(1)*x(6)^2 - x(2)^2*(2*theta(3)*x(15) - 2*theta(4)*x(12)*x(15) + theta(5)*x(12)*x(14) - theta(6)*x(13)*x(14)) - x(2)*(2*theta(4)*x(18) - theta(4)*x(15) - 2*theta(3)*x(15) - theta(5)*x(17) + theta(6)*x(18) + 2*theta(4)*x(12)*x(15) - theta(5)*x(12)*x(14) + theta(6)*x(13)*x(14) + 2*theta(1)*x(1)*x(3)*x(15) + theta(1)*x(1)*x(4)*x(14) - 2*theta(1)*x(1)*x(12)*x(15) - theta(1)*x(1)*x(13)*x(14) + 2*theta(7)*x(1)*x(6)*x(15) + theta(7)*x(1)*x(7)*x(14) + theta(7)*x(1)*x(4)^2*x(14) + 2*theta(7)*x(1)*x(3)*x(4)*x(15) - 2*theta(7)*x(1)*x(4)*x(12)*x(15) - theta(7)*x(1)*x(4)*x(13)*x(14)) + theta(1)*x(1)*x(9) - theta(1)*x(1)*x(18) + 2*theta(1)*x(1)*x(3)*x(6) + theta(1)*x(1)*x(4)*x(5) - theta(1)*x(1)*x(5)*x(13) - 2*theta(1)*x(1)*x(6)*x(12) + theta(7)*x(1)*x(5)*x(7) + 2*theta(7)*x(1)*x(3)*x(10) + 2*theta(7)*x(1)*x(4)*x(9) - theta(7)*x(1)*x(4)*x(18) - theta(7)*x(1)*x(9)*x(13) - 2*theta(7)*x(1)*x(10)*x(12) + theta(1)*x(1)*x(3)^2*x(4) + theta(7)*x(1)*x(4)^2*x(5) + theta(1)*x(1)*x(4)*x(12)^2 - theta(1)*x(1)*x(3)^2*x(13) + theta(7)*x(1)*x(3)^2*x(7) - theta(1)*x(1)*x(12)^2*x(13) + theta(7)*x(1)*x(7)*x(12)^2 + theta(7)*x(1)*x(3)^2*x(4)^2 + theta(7)*x(1)*x(4)^2*x(12)^2 - 2*theta(7)*x(1)*x(3)*x(4)^2*x(12) - theta(7)*x(1)*x(3)^2*x(4)*x(13) - theta(7)*x(1)*x(4)*x(12)^2*x(13) - 2*theta(1)*x(1)*x(3)*x(4)*x(12) + 4*theta(7)*x(1)*x(3)*x(4)*x(6) + 2*theta(1)*x(1)*x(3)*x(12)*x(13) - 2*theta(7)*x(1)*x(3)*x(6)*x(13) - 2*theta(7)*x(1)*x(3)*x(7)*x(12) - theta(7)*x(1)*x(4)*x(5)*x(13) - 4*theta(7)*x(1)*x(4)*x(6)*x(12) + 2*theta(7)*x(1)*x(6)*x(12)*x(13) + 2*theta(7)*x(1)*x(3)*x(4)*x(12)*x(13);...
         theta(1)*x(1)*x(10) - x(2)*(theta(4)*x(19) - theta(5)*x(14) - theta(6)*x(15) - theta(3)*x(16) - 2*theta(5)*x(18) + 2*theta(6)*x(19) + theta(4)*x(12)*x(16) - 2*theta(5)*x(12)*x(15) + 2*theta(6)*x(13)*x(15) + theta(1)*x(1)*x(3)*x(16) + 2*theta(1)*x(1)*x(4)*x(15) - theta(1)*x(1)*x(12)*x(16) - 2*theta(1)*x(1)*x(13)*x(15) + theta(7)*x(1)*x(6)*x(16) + 2*theta(7)*x(1)*x(7)*x(15) + 2*theta(7)*x(1)*x(4)^2*x(15) + theta(7)*x(1)*x(3)*x(4)*x(16) - theta(7)*x(1)*x(4)*x(12)*x(16) - 2*theta(7)*x(1)*x(4)*x(13)*x(15)) - x(2)^2*(theta(3)*x(16) - theta(4)*x(12)*x(16) + 2*theta(5)*x(12)*x(15) - 2*theta(6)*x(13)*x(15)) - theta(1)*x(1)*x(19) + theta(1)*x(1)*x(3)*x(7) + 2*theta(1)*x(1)*x(4)*x(6) - 2*theta(1)*x(1)*x(6)*x(13) - theta(1)*x(1)*x(7)*x(12) + 3*theta(7)*x(1)*x(6)*x(7) + theta(7)*x(1)*x(3)*x(11) + 3*theta(7)*x(1)*x(4)*x(10) - theta(7)*x(1)*x(4)*x(19) - 2*theta(7)*x(1)*x(10)*x(13) - theta(7)*x(1)*x(11)*x(12) + theta(1)*x(1)*x(3)*x(4)^2 + theta(7)*x(1)*x(3)*x(4)^3 + theta(1)*x(1)*x(3)*x(13)^2 - theta(1)*x(1)*x(4)^2*x(12) + 3*theta(7)*x(1)*x(4)^2*x(6) - theta(7)*x(1)*x(4)^3*x(12) - theta(1)*x(1)*x(12)*x(13)^2 + theta(7)*x(1)*x(6)*x(13)^2 + theta(7)*x(1)*x(3)*x(4)*x(13)^2 - 2*theta(7)*x(1)*x(3)*x(4)^2*x(13) - theta(7)*x(1)*x(4)*x(12)*x(13)^2 + 2*theta(7)*x(1)*x(4)^2*x(12)*x(13) - 2*theta(1)*x(1)*x(3)*x(4)*x(13) + 3*theta(7)*x(1)*x(3)*x(4)*x(7) + 2*theta(1)*x(1)*x(4)*x(12)*x(13) - 2*theta(7)*x(1)*x(3)*x(7)*x(13) - 4*theta(7)*x(1)*x(4)*x(6)*x(13) - 3*theta(7)*x(1)*x(4)*x(7)*x(12) + 2*theta(7)*x(1)*x(7)*x(12)*x(13);...
         x(2)*(theta(5)*x(12) - theta(6)*x(13) + 3*theta(5)*x(15) + 3*theta(6)*x(16) + 3*theta(5)*x(19) - 3*theta(6)*x(20) + 3*theta(5)*x(12)*x(16) - 3*theta(6)*x(13)*x(16) - 3*theta(1)*x(1)*x(4)*x(16) + 3*theta(1)*x(1)*x(13)*x(16) - 3*theta(7)*x(1)*x(7)*x(16) - 3*theta(7)*x(1)*x(4)^2*x(16) + 3*theta(7)*x(1)*x(4)*x(13)*x(16)) - x(2)^2*(3*theta(5)*x(12)*x(16) - 3*theta(6)*x(13)*x(16)) + theta(1)*x(1)*x(4)^3 + theta(7)*x(1)*x(4)^4 + 3*theta(7)*x(1)*x(7)^2 - theta(1)*x(1)*x(13)^3 + theta(1)*x(1)*x(11) - theta(1)*x(1)*x(20) + 3*theta(1)*x(1)*x(4)*x(7) - 3*theta(1)*x(1)*x(7)*x(13) + 4*theta(7)*x(1)*x(4)*x(11) - theta(7)*x(1)*x(4)*x(20) - 3*theta(7)*x(1)*x(11)*x(13) + 3*theta(1)*x(1)*x(4)*x(13)^2 - 3*theta(1)*x(1)*x(4)^2*x(13) + 6*theta(7)*x(1)*x(4)^2*x(7) - theta(7)*x(1)*x(4)*x(13)^3 - 3*theta(7)*x(1)*x(4)^3*x(13) + 3*theta(7)*x(1)*x(7)*x(13)^2 + 3*theta(7)*x(1)*x(4)^2*x(13)^2 - 9*theta(7)*x(1)*x(4)*x(7)*x(13)];

%% MASS MATRIX
function [M] = MMat(t,x,theta,kappa) 

M = spdiags([1;...
         1;...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(1);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2);...
         x(2)],0,20,20);

%% OUTPUT MAP
function y = rhsO(t,x,theta,kappa) 

y = [x(:,1),...
         x(:,2),...
         x(:,1).*x(:,3) + x(:,2).*x(:,12),...
         x(:,1).*x(:,4) + x(:,2).*x(:,13),...
         x(:,1).*(x(:,1) - 1).^2 + x(:,1).^2.*x(:,2),...
         x(:,1).*x(:,2).*(x(:,1) + x(:,2) - 2),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)) + x(:,1).*(x(:,1) - 1).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)),...
         x(:,2).*(x(:,2) - 1).^2 + x(:,1).*x(:,2).^2,...
         x(:,1).*x(:,2).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)),...
         x(:,1).*x(:,2).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)) + x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)),...
         x(:,1).*(x(:,5) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).^2) + x(:,2).*(x(:,14) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).^2),...
         x(:,1).*(x(:,6) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13))) + x(:,2).*(x(:,15) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13))),...
         x(:,1).*(x(:,7) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^2) + x(:,2).*(x(:,16) + (x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^2),...
         - x(:,1).*(x(:,1) - 1).^3 - x(:,1).^3.*x(:,2),...
         - x(:,1).*x(:,2).*(x(:,1) - 1).^2 - x(:,1).^2.*x(:,2).*(x(:,2) - 1),...
         - x(:,1).^2.*x(:,2).*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)) - x(:,1).*(x(:,1) - 1).^2.*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)),...
         - x(:,1).^2.*x(:,2).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)) - x(:,1).*(x(:,1) - 1).^2.*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)),...
         - x(:,1).*x(:,2).^2.*(x(:,1) - 1) - x(:,1).*x(:,2).*(x(:,2) - 1).^2,...
         - x(:,1).*x(:,2).*(x(:,1) - 1).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)) - x(:,1).*x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)),...
         - x(:,1).*x(:,2).*(x(:,1) - 1).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)) - x(:,1).*x(:,2).*(x(:,2) - 1).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)),...
         - x(:,1).*x(:,2).*(x(:,14) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).^2) - x(:,1).*(x(:,5) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).^2).*(x(:,1) - 1),...
         - x(:,1).*x(:,2).*(x(:,15) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13))) - x(:,1).*(x(:,1) - 1).*(x(:,6) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13))),...
         - x(:,1).*x(:,2).*(x(:,16) + (x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^2) - x(:,1).*(x(:,7) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^2).*(x(:,1) - 1),...
         - x(:,2).*(x(:,2) - 1).^3 - x(:,1).*x(:,2).^3,...
         - x(:,1).*x(:,2).^2.*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)) - x(:,2).*(x(:,2) - 1).^2.*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)),...
         - x(:,1).*x(:,2).^2.*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)) - x(:,2).*(x(:,2) - 1).^2.*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)),...
         - x(:,1).*x(:,2).*(x(:,5) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).^2) - x(:,2).*(x(:,14) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).^2).*(x(:,2) - 1),...
         - x(:,1).*x(:,2).*(x(:,6) + (x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13))) - x(:,2).*(x(:,2) - 1).*(x(:,15) + (x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13))),...
         - x(:,1).*x(:,2).*(x(:,7) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^2) - x(:,2).*(x(:,16) + (x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^2).*(x(:,2) - 1),...
         - x(:,1).*((x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).^3 - x(:,8) + x(:,5).*(3.*x(:,1).*x(:,3) - 3.*x(:,3) + 3.*x(:,2).*x(:,12))) - x(:,2).*((x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).^3 - x(:,17) + x(:,14).*(3.*x(:,1).*x(:,3) - 3.*x(:,12) + 3.*x(:,2).*x(:,12))),...
         - x(:,1).*((x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).^2.*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)) - x(:,9) + x(:,5).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)) + x(:,6).*(2.*x(:,1).*x(:,3) - 2.*x(:,3) + 2.*x(:,2).*x(:,12))) - x(:,2).*((x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).^2.*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)) - x(:,18) + x(:,14).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)) + x(:,15).*(2.*x(:,1).*x(:,3) - 2.*x(:,12) + 2.*x(:,2).*x(:,12))),...
         - x(:,1).*((x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^2 - x(:,10) + x(:,7).*(x(:,1).*x(:,3) - x(:,3) + x(:,2).*x(:,12)) + x(:,6).*(2.*x(:,1).*x(:,4) - 2.*x(:,4) + 2.*x(:,2).*x(:,13))) - x(:,2).*((x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)).*(x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^2 - x(:,19) + x(:,16).*(x(:,1).*x(:,3) - x(:,12) + x(:,2).*x(:,12)) + x(:,15).*(2.*x(:,1).*x(:,4) - 2.*x(:,13) + 2.*x(:,2).*x(:,13))),...
         - x(:,1).*((x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^3 - x(:,11) + x(:,7).*(3.*x(:,1).*x(:,4) - 3.*x(:,4) + 3.*x(:,2).*x(:,13))) - x(:,2).*((x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^3 - x(:,20) + x(:,16).*(3.*x(:,1).*x(:,4) - 3.*x(:,13) + 3.*x(:,2).*x(:,13))),...
         theta(9) + theta(8).*(x(:,1).*x(:,4) + x(:,2).*x(:,13)),...
         theta(8).^2.*(x(:,1).*(x(:,7) + (x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^2) + x(:,2).*(x(:,16) + (x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^2)),...
         -theta(8).^3.*(x(:,1).*((x(:,1).*x(:,4) - x(:,4) + x(:,2).*x(:,13)).^3 - x(:,11) + x(:,7).*(3.*x(:,1).*x(:,4) - 3.*x(:,4) + 3.*x(:,2).*x(:,13))) + x(:,2).*((x(:,1).*x(:,4) - x(:,13) + x(:,2).*x(:,13)).^3 - x(:,20) + x(:,16).*(3.*x(:,1).*x(:,4) - 3.*x(:,13) + 3.*x(:,2).*x(:,13))))];


%% INITIAL CONDITIONS FOR STATE
function x0 = x0fun(theta,kappa) 

x0 = [562949953365017/562949953421312;...
       1/10000000000;...
       kappa(4)*kappa(18) - theta(10)*(kappa(4) - 1);...
       kappa(5)*kappa(19);...
       kappa(13)*kappa(27);...
       kappa(14)*kappa(28);...
       kappa(15)*kappa(29);...
       1/10000000000;...
       1/10000000000;...
       1/10000000000;...
       1/10000000000;...
       kappa(4)*kappa(18) - theta(10)*(kappa(4) - 1);...
       kappa(5)*kappa(19);...
       kappa(13)*kappa(27);...
       kappa(14)*kappa(28);...
       kappa(15)*kappa(29);...
       1/10000000000;...
       1/10000000000;...
       1/10000000000;...
       1/10000000000];


